import Expo from 'expo'
import _ from 'lodash'
import firebase from 'firebase'

export const getContactsAsync = async () => {
  let contacts = []
  try {
    contacts = await Expo.Contacts.getContactsAsync({
      fields: [Expo.Contacts.PHONE_NUMBERS],
      pageSize: 10000,
      pageOffset: 0
    })
  } catch (e) {
    console.error(e)
    console.error('could not get contacts')
  }

  return formatContacts(contacts)
}

export const getUsersNumbers = async () => {
  let usersNumbers = []
  try {
    await firebase
      .database()
      .ref('/users')
      .once('value', snapshot => {
        usersNumbers = Object.keys(snapshot.val())
      })
  } catch (e) {
    console.error('Could not get users numbers')
    console.error(e)
  }
  return usersNumbers
}

export const formatContacts = contacts => {
  let contactsNamesAndNumbers = []

  contacts.data.filter(contact => contact.phoneNumbers[0]).forEach(contact =>
    contact.phoneNumbers.forEach(phoneNumber => {
      const { name } = contact
      const number = formatPhone(phoneNumber.number)
      if (
        number.length === 10
        // !_.some(this.props.myFriends, ['number', number])
      ) {
        contactsNamesAndNumbers.push({ name, number })
      }
    })
  )

  contactsNamesAndNumbers = _.uniqWith(contactsNamesAndNumbers, _.isEqual)
  return _.sortBy(contactsNamesAndNumbers, contact => contact.name)
}

export const formatPhone = phone => {
  const number = String(phone).replace(/[^\d]/g, '')
  return number.charAt(0) === '1' ? number.substring(1) : number
}
